Index: app.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import express from \"express\";\r\nimport path from \"path\";\r\nimport indexRouter from \"./routes/index.js\";\r\nimport HttpError from \"http-errors\";\r\nimport authorization from \"./middlewares/authorization.js\";\r\nimport errorHandler from \"./middlewares/errorHandler.js\";\r\nimport cors from \"./middlewares/cors.js\";\r\nimport Users from \"./models/Users.js\";\r\n\r\nconst app = express();\r\n\r\napp.use(cors);\r\napp.use(express.urlencoded({ extended: true }));\r\napp.use(express.json());\r\napp.use(express.static(path.resolve('public')));\r\n\r\napp.use(authorization)\r\n\r\napp.use(indexRouter)\r\n\r\napp.use((req, res, next) => {\r\n  next(HttpError(404))\r\n})\r\n\r\napp.use(errorHandler)\r\n\r\napp.listen(4000,  () => {\r\n  console.log('server started ...')\r\n})\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app.js b/app.js
--- a/app.js	(revision daf0da99674e8ba0743bc30b669959f6435f6775)
+++ b/app.js	(date 1701382071795)
@@ -5,7 +5,6 @@
 import authorization from "./middlewares/authorization.js";
 import errorHandler from "./middlewares/errorHandler.js";
 import cors from "./middlewares/cors.js";
-import Users from "./models/Users.js";
 
 const app = express();
 
@@ -24,6 +23,6 @@
 
 app.use(errorHandler)
 
-app.listen(4000,  () => {
+app.listen(process.env.PORT,  () => {
   console.log('server started ...')
 })
Index: .env
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>MYSQL_HOST=127.0.0.1\r\nMYSQL_PORT=3306\r\nMYSQL_DATABASE=touresArmenia\r\nMYSQL_USER=root\r\nMYSQL_PASSWORD=\r\n\r\nPASSWORD_SECRET=1q2w3e4r5t6y7u8i9o\r\n\r\nJWT_SECRET=q1w2e3r4t5y6u7i8o9\r\n\r\nINFO_EMAIL=tourinfo.arm@gmail.com\r\nAPP_PASS=zavj rklt mczj tfvp\r\n\r\nBASE_URL=http://localhost:4000/
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/.env b/.env
--- a/.env	(revision daf0da99674e8ba0743bc30b669959f6435f6775)
+++ b/.env	(date 1701374979728)
@@ -11,4 +11,5 @@
 INFO_EMAIL=tourinfo.arm@gmail.com
 APP_PASS=zavj rklt mczj tfvp
 
-BASE_URL=http://localhost:4000/
\ No newline at end of file
+BASE_URL=http://localhost:4000/
+PORT = 4000
Index: routes/users.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import { Router } from \"express\";\r\nimport UsersController from \"../controllers/UsersController.js\";\r\nimport validate from \"../middlewares/validate.js\";\r\nimport usersSchema from \"../schema/usersSchema.js\";\r\n\r\nconst router = Router();\r\n\r\n\r\nrouter.post(\r\n  '/register',\r\n  validate(usersSchema.register),\r\n  UsersController.register\r\n);\r\n\r\nrouter.post('/activate', UsersController.activate)\r\n\r\nrouter.post('/login', validate(usersSchema.login), UsersController.login)\r\n\r\nrouter.get('/profile',UsersController.profile)\r\n\r\n\r\nexport default router;
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/routes/users.js b/routes/users.js
--- a/routes/users.js	(revision daf0da99674e8ba0743bc30b669959f6435f6775)
+++ b/routes/users.js	(date 1701374801051)
@@ -13,10 +13,9 @@
 );
 
 router.post('/activate', UsersController.activate)
-
 router.post('/login', validate(usersSchema.login), UsersController.login)
 
 router.get('/profile',UsersController.profile)
 
 
-export default router;
\ No newline at end of file
+export default router;
Index: middlewares/authorization.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import jwt from \"jsonwebtoken\";\r\nimport HttpError from \"http-errors\";\r\n\r\nconst { JWT_SECRET } = process.env;\r\n\r\nconst EXCLUDES = [\r\n  'POST:/users/register',\r\n  'POST:/users/login',\r\n  'POST:/users/activate',\r\n  'POST:/categories/create',\r\n  'GET:/categories/list',\r\n  'POST:/toures/create',\r\n];\r\n\r\nexport default function authorization(req, res, next) {\r\n\r\n  try {\r\n    const requestPath = `${req.method}:${req.path}`;\r\n\r\n    if (EXCLUDES.includes(requestPath) || req.method === 'OPTIONS') {\r\n\r\n      next();\r\n      return;\r\n    }\r\n    if (requestPath.includes('PATCH:/categories/update/') || requestPath.includes('DELETE:/categories/delete/') ||  requestPath.includes('GET:/toures/getTour/')) {\r\n      next();\r\n      return;\r\n    }\r\n\r\n    const { authorization } = req.headers;\r\n\r\n    const { userId } = jwt.verify(authorization, JWT_SECRET)\r\n    if (!userId) {\r\n      throw HttpError(401)\r\n    }\r\n    req.userId = userId;\r\n    next();\r\n  } catch (e) {\r\n    e.status = 401;\r\n    next(e);\r\n  }\r\n}\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/middlewares/authorization.js b/middlewares/authorization.js
--- a/middlewares/authorization.js	(revision daf0da99674e8ba0743bc30b669959f6435f6775)
+++ b/middlewares/authorization.js	(date 1701374801059)
@@ -28,8 +28,8 @@
     }
 
     const { authorization } = req.headers;
-
-    const { userId } = jwt.verify(authorization, JWT_SECRET)
+    const token = authorization.replace('Bearer', "").trim()
+    const { userId } = jwt.verify(token, JWT_SECRET)
     if (!userId) {
       throw HttpError(401)
     }
